<link href="~/html/css/shopstyle.css" rel="stylesheet" />
<body>
    <style>
        a:focus {
            -webkit-tap-highlight-color: rgba(0,0,0,0);
            -webkit-box-shadow: 0 0 10px rgba(0,5,174,1);
        }

      
    </style>
    <div class="step_tip">
    </div>
    <div class="webM">
        <h3>购物车结算
		</h3>
        <table class="shopcart" id="shopCart" cellpadding="0" cellspacing="0">
            <tbody>
                <tr>
                    <th width="10%">序号</th>
                    <th width="10%">商品图片</th>
                    <th width="25%">商品名称</th>
                    <th width="20%">数量</th>
                    <th width="10%">单价</th>
                    <th width="10%">总价</th>
                    <th width="15%">操作</th>
                </tr>
            </tbody>
            <tbody id="InnerBody"></tbody>
        </table>
        <a class="btn btnBl" href="javascript:void(0)" onclick="deleteAll()" style="margin-bottom: 90px">清空购物车</a>
        <div class="cart_info" style="margin-bottom: 90px" id="txtCartInfo"></div>
        <div class="clear"></div>
    </div>

    <div class="cart_bottom">
        <p class="total_price" id="txtTotalPrice">576元</p>
        <a class="btn disB" href="javascript:void(0)" onclick="toBlance()">去结算</a> 
    </div>
    <script>
        $(document).ready(function () {
            updateCartTip();
        });
        var preStorage = "shoppingCart_";
        //更新角标和总金额 

        function updateCartTip() {
            var html = "";
            var totalNum = 0;
            var totalPrice = 0;
            var storage = window.localStorage;
            var i = 1;
            for (var key in storage) {
                if (key.indexOf(preStorage) >= 0) {
                    var item = storage.getItem(key);
                    if (item) {
                        item = JSON.parse(item);
                        var optionM = "shopCartOptionM" + item.id;
                        var optionA = "shopCartOptionA" + item.id;
                        totalNum += item.num;
                        totalPrice +=  item.price * item.num ;
                        var imagePath = item.imagePath;
                        //todo..............
                        var imagePath = "http://h.hiphotos.baidu.com/image/pic/item/b7003af33a87e950d2acb36d12385343fbf2b47c.jpg";
                        html += "<tr>";
                        html += "<td width=\"10%\">" + (i++) + "</td>";
                        html += "<td class=\"list_img\">";
                        html += "<img src=\"" + imagePath + "\" width=\"150\" height=\"150\">";
                        html += "</td>";
                        html += "<td>" + item.name + "</td>";
                        html += "<td>";
                        html += "<a class=\"numC\" href=\"javascript:void(0)\" id=\""+optionM+"\" onclick=\"optionCartNum('" + item.id + "',0,'"+optionM+"')\">-</a>";
                        html += "<span class=\"numS\" >" + item.num + "</span>";
                        html += "<a class=\"numC\" href=\"javascript:void(0)\" id=\"" + optionA + "\"  onclick=\"optionCartNum('" + item.id + "',1,'" + optionA+ "')\">+</a>";
                        html += "</td>";
                        html += "<td>" + item.price + "</td>";
                        html += "<td>" + (item.price * item.num).toFixed(2) + "</td>";
                        html += "<td>";
                        html += "<a href=\"javascript:void(0)\" onclick=\"deleteItem('" + item.id + "')\" class=\"btn\">删除</a>";
                        html += "</td>";
                        html += "</tr>";
                    }
                }
            }
            //$("#shopCart").html(html);
            document.getElementById("InnerBody").innerHTML = html;
            document.getElementById("txtCartInfo").innerText = totalNum + "件商品,共" + totalPrice.toFixed(2) + "元";
            document.getElementById("txtTotalPrice").innerText = totalPrice.toFixed(2) + "元";
            $("#" + localStorage.shopCartCurrentFocuse).focus();

        }

        //减少增加产品数量
        //type=1增加，type=0:减少

        function optionCartNum(id, type,obj) {
            var key = preStorage + id;
            var item = localStorage.getItem(key);
            console.log(id);
            if (item) {
                var lastItem = JSON.parse(item);
                if (lastItem) {
                    if (type == 0)
                        lastItem.num = lastItem.num - 1;
                    else if (type == 1)
                        lastItem.num = lastItem.num + 1;
                }
                //产品数量为0时，直接删除
                if (lastItem.num == 0)
                    localStorage.removeItem(key);
                else
                    localStorage.setItem(key, JSON.stringify(lastItem));
                saveFocus(obj);
                updateCartTip();
                
            }
        }

        //删除产品

        function deleteItem(id) {
            localStorage.removeItem(preStorage + id);
            updateCartTip();
        }

        //删除所有

        function deleteAll() {
            var storage = window.localStorage;
            for (var key in storage) {
                if (key.indexOf(preStorage) >= 0) {
                    localStorage.removeItem(key);
                }
            }

            updateCartTip();
        }

        //保存当前焦点
        function saveFocus(obj) { 
            localStorage.shopCartCurrentFocuse = obj;
        }
        
        //结算
        function toBlance() {
            var storage = window.localStorage;
            var i = 0;
            for (var key in storage) {
                if (key.indexOf(preStorage) >= 0) {
                    i++;
                }
            }
            if (i > 0) {
                window.location.href ='@Url.Content("~/HotelCommodity/pay")';
            } else {
                //todo
                alert("购物车中空空空");
            }
        }
    </script>

</body>
